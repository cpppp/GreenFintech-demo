{
  "_format": "hh3-sol-build-info-1",
  "id": "solc-0_8_28-60c10f39e93b6f9c06f11c9266102a7fbac5fd4e",
  "solcVersion": "0.8.28",
  "solcLongVersion": "0.8.28+commit.7893614a",
  "userSourceNameMap": {
    "contracts/GreenLoanContract.sol": "project/contracts/GreenLoanContract.sol"
  },
  "input": {
    "language": "Solidity",
    "settings": {
      "evmVersion": "cancun",
      "optimizer": {
        "enabled": true,
        "runs": 200
      },
      "outputSelection": {
        "*": {
          "": [
            "ast"
          ],
          "*": [
            "abi",
            "evm.bytecode",
            "evm.deployedBytecode",
            "evm.methodIdentifiers",
            "metadata"
          ]
        }
      },
      "remappings": []
    },
    "sources": {
      "project/contracts/GreenLoanContract.sol": {
        "content": "/**\r\n * @title 预制菜企业绿色贷款智能合约\r\n * @dev 基于区块链的预制菜企业绿色贷款管理系统\r\n * 该合约实现了企业注册、绿色表现数据管理、积分计算、贷款申请与发放等功能\r\n * 本Demo版本进行了功能简化，聚焦于核心业务流程\r\n */\r\n// SPDX-License-Identifier: MIT\r\npragma solidity ^0.8.0;\r\n\r\ncontract GreenLoanContract {\r\n    /**\r\n     * @dev 管理员地址\r\n     * 合约部署者自动成为管理员，拥有最高权限\r\n     */\r\n    address public admin;\r\n    \r\n    /**\r\n     * @dev 角色常量定义\r\n     * 用于权限管理和身份识别\r\n     */\r\n    bytes32 public constant ADMIN_ROLE = keccak256(\"ADMIN_ROLE\");\r\n    bytes32 public constant ENTERPRISE_ROLE = keccak256(\"ENTERPRISE_ROLE\");\r\n    \r\n    /**\r\n     * @dev 贷款参数配置\r\n     * 所有利率均以万分之几为单位存储，避免浮点数精度问题\r\n     */\r\n    uint256 public normalLoanRate; // 正常贷款利率（万分之几）\r\n    uint256 public greenLoanRate;  // 绿色优惠贷款利率（万分之几）\r\n    uint256 public fixedLoanAmount; // 固定贷款额度\r\n    \r\n    /**\r\n     * @dev 积分参数配置\r\n     * 用于控制绿色表现评估和贷款资格判定\r\n     */\r\n    uint256 public greenThreshold; // 绿色达标阈值（百分比，如15表示15%）\r\n    uint256 public minPointsForGreenLoan; // 绿色贷款所需最低积分\r\n    uint256 public dataValidPeriod; // 数据有效期限（秒）\r\n    \r\n    /**\r\n     * @dev 企业信息结构体\r\n     * 存储企业的基本信息、认证状态和积分数据\r\n     */\r\n    struct Enterprise {\r\n        string name; // 企业名称\r\n        string socialCreditCodeHash; // 统一社会信用代码哈希值\r\n        bool isVerified; // 是否已通过管理员认证\r\n        uint256 totalPoints; // 企业累计绿色积分\r\n        uint256 lastDataUploadTime; // 最后一次上传数据的时间戳\r\n    }\r\n    \r\n    /**\r\n     * @dev 绿色表现数据结构体\r\n     * 记录企业的绿色表现数据、核验状态和积分情况\r\n     */\r\n    struct GreenData {\r\n        uint256 baseline; // 基准线数据（如原能耗）\r\n        uint256 actualData; // 实际表现数据（如当前能耗）\r\n        string dataType; // 数据类型（如\"能耗\"、\"包装排放\"等）\r\n        uint256 timestamp; // 数据上传时间戳\r\n        bool isValid; // 是否已通过管理员核验\r\n        uint256 pointsEarned; // 该数据获得的积分\r\n    }\r\n    \r\n    /**\r\n     * @dev 贷款记录结构体\r\n     * 存储贷款的详细信息和状态\r\n     */\r\n    struct Loan {\r\n        uint256 id; // 贷款唯一标识\r\n        address enterprise; // 申请贷款的企业地址\r\n        bool isGreenLoan; // 是否为绿色优惠贷款\r\n        uint256 rate; // 贷款利率（万分之几）\r\n        uint256 amount; // 贷款金额\r\n        uint256 timestamp; // 贷款申请时间戳\r\n        string status; // 贷款状态（\"pending\", \"approved\", \"paid\"）\r\n    }\r\n    \r\n    /**\r\n     * @dev 映射：企业地址 => 企业信息\r\n     * 用于快速查找和访问企业信息\r\n     */\r\n    mapping(address => Enterprise) public enterprises;\r\n    \r\n    /**\r\n     * @dev 映射：企业地址 => 数据记录数组\r\n     * 存储每个企业的所有绿色表现数据\r\n     */\r\n    mapping(address => GreenData[]) public enterpriseData;\r\n    \r\n    /**\r\n     * @dev 映射：企业地址 => 贷款记录数组\r\n     * 存储每个企业的所有贷款申请记录\r\n     */\r\n    mapping(address => Loan[]) public enterpriseLoans;\r\n    \r\n    /**\r\n     * @dev 全局贷款ID计数器\r\n     * 用于生成唯一的贷款ID\r\n     */\r\n    uint256 public loanIdCounter;\r\n    \r\n    /**\r\n     * @dev 已注册企业地址列表\r\n     * 存储所有提交注册申请的企业地址\r\n     */\r\n    address[] public registeredEnterprises;\r\n    \r\n    /**\r\n     * @dev 事件定义\r\n     * 用于记录合约关键操作，便于链下监听和审计\r\n     */\r\n    event EnterpriseRegistered(address indexed enterprise, string name); // 企业注册事件\r\n    event EnterpriseVerified(address indexed enterprise); // 企业认证事件\r\n    event GreenDataUploaded(address indexed enterprise, uint256 dataId); // 绿色数据上传事件\r\n    event GreenDataVerified(address indexed enterprise, uint256 dataId, uint256 pointsEarned); // 数据核验事件\r\n    event PointsDeducted(address indexed enterprise, uint256 amount, string reason); // 积分扣减事件\r\n    event LoanApplied(address indexed enterprise, uint256 loanId, bool isGreenLoan); // 贷款申请事件\r\n    event LoanApproved(address indexed enterprise, uint256 loanId, uint256 amount, uint256 rate); // 贷款批准事件\r\n    event ParametersUpdated(string parameterType, uint256 newValue, address updatedBy); // 参数更新事件\r\n    \r\n    /**\r\n     * @dev 修饰器：检查调用者是否为管理员\r\n     * 用于限制只有管理员可以执行的操作\r\n     */\r\n    modifier onlyAdmin() {\r\n        require(msg.sender == admin, \"Caller is not admin\");\r\n        _;\r\n    }\r\n    \r\n    /**\r\n     * @dev 修饰器：检查企业是否已注册且已认证\r\n     * 用于限制只有已认证企业可以执行的操作\r\n     */\r\n    modifier onlyVerifiedEnterprise() {\r\n        require(enterprises[msg.sender].isVerified, \"Enterprise not verified\");\r\n        _;\r\n    }\r\n    \r\n    /**\r\n     * @dev 构造函数\r\n     * 初始化合约参数和管理员权限\r\n     */\r\n    constructor() {\r\n        admin = msg.sender;\r\n        \r\n        // 设置默认参数\r\n        normalLoanRate = 450; // 4.5%\r\n        greenLoanRate = 430;  // 4.3%\r\n        fixedLoanAmount = 1000000; // 100万\r\n        greenThreshold = 15; // 15%\r\n        minPointsForGreenLoan = 100; // 100分\r\n        dataValidPeriod = 90 * 24 * 60 * 60; // 90天\r\n    }\r\n    \r\n    /**\r\n     * @dev 设置贷款利率\r\n     * @param _normalRate 正常贷款利率（万分之几）\r\n     * @param _greenRate 绿色优惠贷款利率（万分之几）\r\n     * 仅管理员可调用此函数\r\n     */\r\n    function setLoanRates(uint256 _normalRate, uint256 _greenRate) external onlyAdmin {\r\n        require(_normalRate > 0 && _greenRate > 0, \"Rates must be greater than 0\");\r\n        normalLoanRate = _normalRate;\r\n        greenLoanRate = _greenRate;\r\n        emit ParametersUpdated(\"LoanRates\", _normalRate, msg.sender);\r\n    }\r\n    \r\n    /**\r\n     * @dev 设置积分规则\r\n     * @param _threshold 绿色达标阈值（百分比）\r\n     * @param _minPoints 申请绿色贷款所需的最低积分\r\n     * 仅管理员可调用此函数\r\n     */\r\n    function setPointRules(uint256 _threshold, uint256 _minPoints) external onlyAdmin {\r\n        require(_threshold <= 100, \"Threshold cannot exceed 100%\");\r\n        require(_minPoints > 0, \"Minimum points must be greater than 0\");\r\n        greenThreshold = _threshold;\r\n        minPointsForGreenLoan = _minPoints;\r\n        emit ParametersUpdated(\"PointRules\", _threshold, msg.sender);\r\n    }\r\n    \r\n    /**\r\n     * @dev 设置贷款基础参数\r\n     * @param _amount 固定贷款额度\r\n     * @param _validPeriod 数据有效期限（秒）\r\n     * 仅管理员可调用此函数\r\n     */\r\n    function setLoanParameters(uint256 _amount, uint256 _validPeriod) external onlyAdmin {\r\n        require(_amount > 0, \"Loan amount must be greater than 0\");\r\n        require(_validPeriod > 0, \"Valid period must be greater than 0\");\r\n        fixedLoanAmount = _amount;\r\n        dataValidPeriod = _validPeriod;\r\n        emit ParametersUpdated(\"LoanParameters\", _amount, msg.sender);\r\n    }\r\n    \r\n    /**\r\n     * @dev 企业注册\r\n     * @param _name 企业名称\r\n     * @param _socialCreditCodeHash 统一社会信用代码的哈希值\r\n     * 任意地址均可调用此函数提交注册申请\r\n     */\r\n    function registerEnterprise(string calldata _name, string calldata _socialCreditCodeHash) external {\r\n        require(bytes(_name).length > 0, \"Enterprise name cannot be empty\");\r\n        require(bytes(_socialCreditCodeHash).length > 0, \"Social credit code hash cannot be empty\");\r\n        require(!enterprises[msg.sender].isVerified, \"Enterprise already registered\");\r\n        \r\n        enterprises[msg.sender] = Enterprise({\r\n            name: _name,\r\n            socialCreditCodeHash: _socialCreditCodeHash,\r\n            isVerified: false,\r\n            totalPoints: 0,\r\n            lastDataUploadTime: 0\r\n        });\r\n        \r\n        registeredEnterprises.push(msg.sender);\r\n        \r\n        emit EnterpriseRegistered(msg.sender, _name);\r\n    }\r\n    \r\n    /**\r\n     * @dev 管理员审核企业\r\n     * @param _enterprise 待审核的企业地址\r\n     * 仅管理员可调用此函数，审核通过后企业才能进行后续操作\r\n     */\r\n    function verifyEnterprise(address _enterprise) external onlyAdmin {\r\n        require(bytes(enterprises[_enterprise].name).length > 0, \"Enterprise not registered\");\r\n        require(!enterprises[_enterprise].isVerified, \"Enterprise already verified\");\r\n        \r\n        enterprises[_enterprise].isVerified = true;\r\n        \r\n        emit EnterpriseVerified(_enterprise);\r\n    }\r\n    \r\n    /**\r\n     * @dev 查询企业自身信息\r\n     * @return name 企业名称\r\n     * @return socialCreditCodeHash 统一社会信用代码哈希\r\n     * @return isVerified 是否已认证\r\n     * @return totalPoints 累计积分\r\n     * 企业可查询自身信息\r\n     */\r\n    function getEnterpriseInfo() external view returns (\r\n        string memory name,\r\n        string memory socialCreditCodeHash,\r\n        bool isVerified,\r\n        uint256 totalPoints\r\n    ) {\r\n        Enterprise memory enterprise = enterprises[msg.sender];\r\n        return (\r\n            enterprise.name,\r\n            enterprise.socialCreditCodeHash,\r\n            enterprise.isVerified,\r\n            enterprise.totalPoints\r\n        );\r\n    }\r\n    \r\n    /**\r\n     * @dev 查询指定企业信息\r\n     * @param _enterprise 企业地址\r\n     * @return name 企业名称\r\n     * @return socialCreditCodeHash 统一社会信用代码哈希\r\n     * @return isVerified 是否已认证\r\n     * @return totalPoints 累计积分\r\n     * 仅管理员可查询任意企业信息\r\n     */\r\n    function getEnterpriseInfoByAddress(address _enterprise) external view onlyAdmin returns (\r\n        string memory name,\r\n        string memory socialCreditCodeHash,\r\n        bool isVerified,\r\n        uint256 totalPoints\r\n    ) {\r\n        Enterprise memory enterprise = enterprises[_enterprise];\r\n        return (\r\n            enterprise.name,\r\n            enterprise.socialCreditCodeHash,\r\n            enterprise.isVerified,\r\n            enterprise.totalPoints\r\n        );\r\n    }\r\n    \r\n    /**\r\n     * @dev 获取已注册企业列表\r\n     * @return 已注册企业地址数组\r\n     * 仅管理员可调用此函数\r\n     */\r\n    function getRegisteredEnterprises() external view onlyAdmin returns (address[] memory) {\r\n        return registeredEnterprises;\r\n    }\r\n    \r\n    /**\r\n     * @dev 获取已注册企业数量\r\n     * @return 企业数量\r\n     * 公开函数，任何人可查询\r\n     */\r\n    function getRegisteredEnterprisesCount() external view returns (uint256) {\r\n        return registeredEnterprises.length;\r\n    }\r\n    \r\n    /**\r\n     * @dev 上传绿色表现数据\r\n     * @param _baseline 基准线数据\r\n     * @param _actualData 实际表现数据\r\n     * @param _dataType 数据类型\r\n     * 仅已认证企业可调用此函数\r\n     */\r\n    function uploadGreenData(uint256 _baseline, uint256 _actualData, string calldata _dataType) external onlyVerifiedEnterprise {\r\n        require(_baseline > 0, \"Baseline must be greater than 0\");\r\n        require(_actualData <= _baseline, \"Actual data must be less than or equal to baseline\");\r\n        require(bytes(_dataType).length > 0, \"Data type cannot be empty\");\r\n        \r\n        GreenData memory newData = GreenData({\r\n            baseline: _baseline,\r\n            actualData: _actualData,\r\n            dataType: _dataType,\r\n            timestamp: block.timestamp,\r\n            isValid: false,\r\n            pointsEarned: 0\r\n        });\r\n        \r\n        enterpriseData[msg.sender].push(newData);\r\n        enterprises[msg.sender].lastDataUploadTime = block.timestamp;\r\n        \r\n        uint256 dataId = enterpriseData[msg.sender].length - 1;\r\n        emit GreenDataUploaded(msg.sender, dataId);\r\n    }\r\n    \r\n    /**\r\n     * @dev 管理员核验绿色表现数据\r\n     * @param _enterprise 企业地址\r\n     * @param _dataId 数据ID\r\n     * 仅管理员可调用此函数，核验通过后自动计算积分\r\n     */\r\n    function verifyGreenData(address _enterprise, uint256 _dataId) external onlyAdmin {\r\n        require(_dataId < enterpriseData[_enterprise].length, \"Invalid data ID\");\r\n        require(!enterpriseData[_enterprise][_dataId].isValid, \"Data already verified\");\r\n        \r\n        GreenData storage data = enterpriseData[_enterprise][_dataId];\r\n        data.isValid = true;\r\n        \r\n        // 计算积分\r\n        uint256 points = 0;\r\n        if (_dataId < enterpriseData[_enterprise].length) {\r\n            uint256 reduction = data.baseline - data.actualData;\r\n            uint256 reductionPercentage = (reduction * 100) / data.baseline;\r\n            \r\n            if (reductionPercentage >= greenThreshold) {\r\n                points = 100; // 达标授予100分\r\n                enterprises[_enterprise].totalPoints += points;\r\n                data.pointsEarned = points;\r\n            }\r\n        }\r\n        \r\n        emit GreenDataVerified(_enterprise, _dataId, points);\r\n    }\r\n    \r\n    /**\r\n     * @dev 查询企业数据记录数量\r\n     * @return 数据记录数量\r\n     * 企业可查询自身数据记录数量\r\n     */\r\n    function getEnterpriseDataCount() external view returns (uint256) {\r\n        return enterpriseData[msg.sender].length;\r\n    }\r\n    \r\n    /**\r\n     * @dev 查询指定企业数据记录数量\r\n     * @param _enterprise 企业地址\r\n     * @return 数据记录数量\r\n     * 仅管理员可调用此函数\r\n     */\r\n    function getEnterpriseDataCountByAddress(address _enterprise) external view onlyAdmin returns (uint256) {\r\n        return enterpriseData[_enterprise].length;\r\n    }\r\n    \r\n    /**\r\n     * @dev 查询企业自身数据记录\r\n     * @param _dataId 数据ID\r\n     * @return baseline 基准线数据\r\n     * @return actualData 实际表现数据\r\n     * @return dataType 数据类型\r\n     * @return timestamp 上传时间戳\r\n     * @return isValid 是否已核验\r\n     * @return pointsEarned 获得的积分\r\n     * 企业可查询自身数据记录详情\r\n     */\r\n    function getEnterpriseData(uint256 _dataId) external view returns (\r\n        uint256 baseline,\r\n        uint256 actualData,\r\n        string memory dataType,\r\n        uint256 timestamp,\r\n        bool isValid,\r\n        uint256 pointsEarned\r\n    ) {\r\n        require(_dataId < enterpriseData[msg.sender].length, \"Invalid data ID\");\r\n        GreenData memory data = enterpriseData[msg.sender][_dataId];\r\n        return (\r\n            data.baseline,\r\n            data.actualData,\r\n            data.dataType,\r\n            data.timestamp,\r\n            data.isValid,\r\n            data.pointsEarned\r\n        );\r\n    }\r\n    \r\n    /**\r\n     * @dev 查询指定企业数据记录\r\n     * @param _enterprise 企业地址\r\n     * @param _dataId 数据ID\r\n     * @return baseline 基准线数据\r\n     * @return actualData 实际表现数据\r\n     * @return dataType 数据类型\r\n     * @return timestamp 上传时间戳\r\n     * @return isValid 是否已核验\r\n     * @return pointsEarned 获得的积分\r\n     * 仅管理员可调用此函数\r\n     */\r\n    function getEnterpriseDataByAddress(address _enterprise, uint256 _dataId) external view onlyAdmin returns (\r\n        uint256 baseline,\r\n        uint256 actualData,\r\n        string memory dataType,\r\n        uint256 timestamp,\r\n        bool isValid,\r\n        uint256 pointsEarned\r\n    ) {\r\n        require(_dataId < enterpriseData[_enterprise].length, \"Invalid data ID\");\r\n        GreenData memory data = enterpriseData[_enterprise][_dataId];\r\n        return (\r\n            data.baseline,\r\n            data.actualData,\r\n            data.dataType,\r\n            data.timestamp,\r\n            data.isValid,\r\n            data.pointsEarned\r\n        );\r\n    }\r\n    \r\n    /**\r\n     * @dev 查询企业当前积分\r\n     * @return 当前累计积分\r\n     * 企业可查询自身积分\r\n     */\r\n    function getEnterprisePoints() external view returns (uint256) {\r\n        return enterprises[msg.sender].totalPoints;\r\n    }\r\n    \r\n    /**\r\n     * @dev 查询指定企业积分\r\n     * @param _enterprise 企业地址\r\n     * @return 当前累计积分\r\n     * 仅管理员可调用此函数\r\n     */\r\n    function getEnterprisePointsByAddress(address _enterprise) external view onlyAdmin returns (uint256) {\r\n        return enterprises[_enterprise].totalPoints;\r\n    }\r\n    \r\n    /**\r\n     * @dev 检查企业是否有资格申请绿色贷款\r\n     * @return 是否符合绿色贷款条件\r\n     * 检查积分是否足够且数据在有效期内\r\n     */\r\n    function canApplyGreenLoan() external view returns (bool) {\r\n        return enterprises[msg.sender].totalPoints >= minPointsForGreenLoan && \r\n               (block.timestamp - enterprises[msg.sender].lastDataUploadTime <= dataValidPeriod);\r\n    }\r\n    \r\n    /**\r\n     * @dev 检查指定企业是否有资格申请绿色贷款\r\n     * @param _enterprise 企业地址\r\n     * @return 是否符合绿色贷款条件\r\n     * 仅管理员可调用此函数\r\n     */\r\n    function canApplyGreenLoanByAddress(address _enterprise) external view onlyAdmin returns (bool) {\r\n        return enterprises[_enterprise].totalPoints >= minPointsForGreenLoan && \r\n               (block.timestamp - enterprises[_enterprise].lastDataUploadTime <= dataValidPeriod);\r\n    }\r\n    \r\n    /**\r\n     * @dev 扣减企业积分（内部函数）\r\n     * @param _enterprise 企业地址\r\n     * @param _amount 扣减的积分数量\r\n     * 用于贷款申请等场景，自动扣减相应积分\r\n     */\r\n    function deductPoints(address _enterprise, uint256 _amount) internal {\r\n        require(enterprises[_enterprise].totalPoints >= _amount, \"Insufficient points\");\r\n        enterprises[_enterprise].totalPoints -= _amount;\r\n        emit PointsDeducted(_enterprise, _amount, \"Green loan application\");\r\n    }\r\n    \r\n    /**\r\n     * @dev 查询贷款类型信息\r\n     * @return normalRate 正常贷款利率\r\n     * @return greenRate 绿色优惠贷款利率\r\n     * @return minGreenPoints 申请绿色贷款所需最低积分\r\n     * @return loanAmount 固定贷款额度\r\n     * @return eligibleForGreen 当前企业是否有资格申请绿色贷款\r\n     * 企业可查询当前贷款相关参数和自身资格\r\n     */\r\n    function getLoanTypesInfo() external view returns (\r\n        uint256 normalRate,\r\n        uint256 greenRate,\r\n        uint256 minGreenPoints,\r\n        uint256 loanAmount,\r\n        bool eligibleForGreen\r\n    ) {\r\n        // 直接实现资格检查逻辑，避免函数调用顺序问题\r\n        bool eligible = enterprises[msg.sender].totalPoints >= minPointsForGreenLoan && \r\n                       (block.timestamp - enterprises[msg.sender].lastDataUploadTime <= dataValidPeriod);\r\n        return (\r\n            normalLoanRate,\r\n            greenLoanRate,\r\n            minPointsForGreenLoan,\r\n            fixedLoanAmount,\r\n            eligible\r\n        );\r\n    }\r\n    \r\n    // 定义转账事件\r\n    event FundTransferred(address indexed admin, address indexed enterprise, uint256 amount);\r\n    \r\n    /**\r\n     * @dev 接收以太币函数\r\n     * 允许向合约转入ETH，用于后续向企业发放贷款\r\n     */\r\n    receive() external payable {}\r\n    \r\n    /**\r\n     * @dev 回退函数\r\n     * 当调用不存在的函数且带有以太币时触发\r\n     */\r\n    fallback() external payable {}\r\n    \r\n    /**\r\n     * @dev 管理员向合约转账函数\r\n     * 允许管理员向合约转入以太币，用于后续向企业发放贷款\r\n     * 仅管理员可调用此函数\r\n     */\r\n    function adminDeposit() external payable onlyAdmin {\r\n        // 验证转账金额大于0\r\n        require(msg.value > 0, \"Transfer amount must be greater than 0\");\r\n        // 记录管理员存款事件\r\n        emit AdminDeposited(msg.sender, msg.value);\r\n    }\r\n    \r\n    /**\r\n     * @dev 管理员存款事件\r\n     * 用于记录管理员向合约的存款操作\r\n     */\r\n    event AdminDeposited(address indexed admin, uint256 amount);\r\n    \r\n    /**\r\n     * @dev 提交贷款申请\r\n     * @param _isGreenLoan 是否申请绿色贷款\r\n     * @return loanId 生成的贷款ID\r\n     * 仅已认证企业可调用此函数，符合条件的申请自动审批通过\r\n     */\r\n    function applyForLoan(bool _isGreenLoan) external onlyVerifiedEnterprise returns (uint256) {\r\n        // 验证申请条件\r\n        if (_isGreenLoan) {\r\n            require(enterprises[msg.sender].totalPoints >= minPointsForGreenLoan, \"Insufficient green points\");\r\n            require(block.timestamp - enterprises[msg.sender].lastDataUploadTime <= dataValidPeriod, \"Green data expired\");\r\n        }\r\n        \r\n        // 创建贷款记录\r\n        uint256 loanId = loanIdCounter++;\r\n        uint256 rate = _isGreenLoan ? greenLoanRate : normalLoanRate;\r\n        \r\n        Loan memory newLoan = Loan({\r\n            id: loanId,\r\n            enterprise: msg.sender,\r\n            isGreenLoan: _isGreenLoan,\r\n            rate: rate,\r\n            amount: fixedLoanAmount,\r\n            timestamp: block.timestamp,\r\n            status: \"approved\" // 简化为自动审批通过\r\n        });\r\n        \r\n        enterpriseLoans[msg.sender].push(newLoan);\r\n        \r\n        // 如果是绿色贷款，扣减积分\r\n        if (_isGreenLoan) {\r\n            deductPoints(msg.sender, minPointsForGreenLoan);\r\n        }\r\n        \r\n        emit LoanApplied(msg.sender, loanId, _isGreenLoan);\r\n        emit LoanApproved(msg.sender, loanId, fixedLoanAmount, rate);\r\n        \r\n        return loanId;\r\n    }\r\n    \r\n    /**\r\n     * @dev 查询企业贷款记录数量\r\n     * @return 贷款记录数量\r\n     * 企业可查询自身贷款记录数量\r\n     */\r\n    function getEnterpriseLoanCount() external view returns (uint256) {\r\n        return enterpriseLoans[msg.sender].length;\r\n    }\r\n    \r\n    /**\r\n     * @dev 查询指定企业贷款记录数量\r\n     * @param _enterprise 企业地址\r\n     * @return 贷款记录数量\r\n     * 仅管理员可调用此函数\r\n     */\r\n    function getEnterpriseLoanCountByAddress(address _enterprise) external view onlyAdmin returns (uint256) {\r\n        return enterpriseLoans[_enterprise].length;\r\n    }\r\n    \r\n    /**\r\n     * @dev 查询企业自身贷款记录\r\n     * @param _loanId 贷款索引\r\n     * @return id 贷款ID\r\n     * @return isGreenLoan 是否为绿色贷款\r\n     * @return rate 贷款利率\r\n     * @return amount 贷款金额\r\n     * @return timestamp 申请时间戳\r\n     * @return status 贷款状态\r\n     * 企业可查询自身贷款记录详情\r\n     */\r\n    function getEnterpriseLoan(uint256 _loanId) external view returns (\r\n        uint256 id,\r\n        bool isGreenLoan,\r\n        uint256 rate,\r\n        uint256 amount,\r\n        uint256 timestamp,\r\n        string memory status\r\n    ) {\r\n        require(_loanId < enterpriseLoans[msg.sender].length, \"Invalid loan ID\");\r\n        Loan memory loan = enterpriseLoans[msg.sender][_loanId];\r\n        return (\r\n            loan.id,\r\n            loan.isGreenLoan,\r\n            loan.rate,\r\n            loan.amount,\r\n            loan.timestamp,\r\n            loan.status\r\n        );\r\n    }\r\n    \r\n    /**\r\n     * @dev 查询指定企业贷款记录\r\n     * @param _enterprise 企业地址\r\n     * @param _loanId 贷款索引\r\n     * @return id 贷款ID\r\n     * @return isGreenLoan 是否为绿色贷款\r\n     * @return rate 贷款利率\r\n     * @return amount 贷款金额\r\n     * @return timestamp 申请时间戳\r\n     * @return status 贷款状态\r\n     * 仅管理员可调用此函数\r\n     */\r\n    function getEnterpriseLoanByAddress(address _enterprise, uint256 _loanId) external view onlyAdmin returns (\r\n        uint256 id,\r\n        bool isGreenLoan,\r\n        uint256 rate,\r\n        uint256 amount,\r\n        uint256 timestamp,\r\n        string memory status\r\n    ) {\r\n        require(_loanId < enterpriseLoans[_enterprise].length, \"Invalid loan ID\");\r\n        Loan memory loan = enterpriseLoans[_enterprise][_loanId];\r\n        return (\r\n            loan.id,\r\n            loan.isGreenLoan,\r\n            loan.rate,\r\n            loan.amount,\r\n            loan.timestamp,\r\n            loan.status\r\n        );\r\n    }\r\n    \r\n    /**\r\n     * @dev 管理员向企业转账1个单位货币\r\n     * @param _enterprise 企业地址\r\n     * 管理员在企业成功申请贷款后调用此函数向企业转账1个单位货币\r\n     * 仅管理员可调用此函数\r\n     */\r\n    function transferFundToEnterprise(address payable _enterprise) external onlyAdmin {\r\n        require(_enterprise != address(0), \"Invalid enterprise address\");\r\n        require(enterprises[_enterprise].isVerified, \"Enterprise not verified\");\r\n        require(enterpriseLoans[_enterprise].length > 0, \"Enterprise has no loan records\");\r\n        \r\n        // 检查该企业是否有已批准但尚未收到转账的贷款\r\n        bool hasApprovedLoan = false;\r\n        for (uint i = 0; i < enterpriseLoans[_enterprise].length; i++) {\r\n            if (keccak256(bytes(enterpriseLoans[_enterprise][i].status)) == keccak256(bytes(\"approved\"))) {\r\n                hasApprovedLoan = true;\r\n                break;\r\n            }\r\n        }\r\n        \r\n        require(hasApprovedLoan, \"Enterprise has no approved loans\");\r\n        \r\n        // 向企业转账1个单位货币（如ETH）\r\n        uint256 transferAmount = 1 ether;\r\n        require(address(this).balance >= transferAmount, \"Insufficient contract balance\");\r\n        \r\n        (bool success, ) = _enterprise.call{value: transferAmount}(\"\");\r\n        require(success, \"Transfer failed\");\r\n        \r\n        emit FundTransferred(msg.sender, _enterprise, transferAmount);\r\n    }\r\n}"
      }
    }
  }
}